<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lowering to logic - Guide to Rustc Development</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A guide to developing rustc">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../about-this-guide.html">About this guide</a></li><li class="spacer"></li><li class="expanded "><a href="../part-1-intro.html"><strong aria-hidden="true">1.</strong> Part 1: Building, debugging, and contributing to Rustc</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../compiler-team.html"><strong aria-hidden="true">1.1.</strong> About the compiler team</a></li><li class=""><a href="../building/how-to-build-and-run.html"><strong aria-hidden="true">1.2.</strong> How to Build and Run the Compiler</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../building/suggested.html"><strong aria-hidden="true">1.2.1.</strong> Suggested Workflows</a></li><li class=""><a href="../building/bootstrapping.html"><strong aria-hidden="true">1.2.2.</strong> Bootstrapping</a></li><li class=""><a href="../building/build-install-distribution-artifacts.html"><strong aria-hidden="true">1.2.3.</strong> Distribution artifacts</a></li><li class=""><a href="../building/compiler-documenting.html"><strong aria-hidden="true">1.2.4.</strong> Documenting Compiler</a></li><li class=""><a href="../building/ctags.html"><strong aria-hidden="true">1.2.5.</strong> ctags</a></li></ol></li><li class=""><a href="../tests/intro.html"><strong aria-hidden="true">1.3.</strong> The compiler testing framework</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../tests/running.html"><strong aria-hidden="true">1.3.1.</strong> Running tests</a></li><li class=""><a href="../tests/adding.html"><strong aria-hidden="true">1.3.2.</strong> Adding new tests</a></li><li class=""><a href="../compiletest.html"><strong aria-hidden="true">1.3.3.</strong> Using compiletest + commands to control test execution</a></li></ol></li><li class=""><a href="../walkthrough.html"><strong aria-hidden="true">1.4.</strong> Walkthrough: a typical contribution</a></li><li class=""><a href="../bug-fix-procedure.html"><strong aria-hidden="true">1.5.</strong> Bug Fix Procedure</a></li><li class=""><a href="../implementing_new_features.html"><strong aria-hidden="true">1.6.</strong> Implementing new features</a></li><li class=""><a href="../stability.html"><strong aria-hidden="true">1.7.</strong> Stability attributes</a></li><li class=""><a href="../stabilization_guide.html"><strong aria-hidden="true">1.8.</strong> Stabilizing Features</a></li><li class=""><a href="../compiler-debugging.html"><strong aria-hidden="true">1.9.</strong> Debugging the Compiler</a></li><li class=""><a href="../profiling.html"><strong aria-hidden="true">1.10.</strong> Profiling the compiler</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../profiling/with_perf.html"><strong aria-hidden="true">1.10.1.</strong> with the linux perf tool</a></li></ol></li><li class=""><a href="../conventions.html"><strong aria-hidden="true">1.11.</strong> Coding conventions</a></li><li class=""><a href="../crates-io.html"><strong aria-hidden="true">1.12.</strong> crates.io Dependencies</a></li><li class=""><a href="../diagnostics.html"><strong aria-hidden="true">1.13.</strong> Emitting Errors and other Diagnostics</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../diagnostics/lintstore.html"><strong aria-hidden="true">1.13.1.</strong> LintStore</a></li><li class=""><a href="../diagnostics/diagnostic-codes.html"><strong aria-hidden="true">1.13.2.</strong> Diagnostic Codes</a></li></ol></li><li class=""><a href="../ice-breaker/about.html"><strong aria-hidden="true">1.14.</strong> ICE-breaker teams</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../ice-breaker/cleanup-crew.html"><strong aria-hidden="true">1.14.1.</strong> &quot;Cleanup Crew&quot; ICE-breakers</a></li><li class=""><a href="../ice-breaker/llvm.html"><strong aria-hidden="true">1.14.2.</strong> LLVM ICE-breakers</a></li></ol></li><li class=""><a href="../licenses.html"><strong aria-hidden="true">1.15.</strong> Licenses</a></li></ol></li><li class="expanded "><a href="../part-2-intro.html"><strong aria-hidden="true">2.</strong> Part 2: How rustc works</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../high-level-overview.html"><strong aria-hidden="true">2.1.</strong> High-level overview of the compiler source</a></li><li class=""><a href="../rustc-driver.html"><strong aria-hidden="true">2.2.</strong> The Rustc Driver and Interface</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../rustdoc.html"><strong aria-hidden="true">2.2.1.</strong> Rustdoc</a></li></ol></li><li class=""><a href="../query.html"><strong aria-hidden="true">2.3.</strong> Queries: demand-driven compilation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../queries/query-evaluation-model-in-detail.html"><strong aria-hidden="true">2.3.1.</strong> The Query Evaluation Model in Detail</a></li><li class=""><a href="../queries/incremental-compilation.html"><strong aria-hidden="true">2.3.2.</strong> Incremental compilation</a></li><li class=""><a href="../queries/incremental-compilation-in-detail.html"><strong aria-hidden="true">2.3.3.</strong> Incremental compilation In Detail</a></li><li class=""><a href="../incrcomp-debugging.html"><strong aria-hidden="true">2.3.4.</strong> Debugging and Testing</a></li><li class=""><a href="../queries/profiling.html"><strong aria-hidden="true">2.3.5.</strong> Profiling Queries</a></li><li class=""><a href="../salsa.html"><strong aria-hidden="true">2.3.6.</strong> Salsa</a></li></ol></li><li class=""><a href="../memory.html"><strong aria-hidden="true">2.4.</strong> Memory Management in Rustc</a></li><li class=""><a href="../the-parser.html"><strong aria-hidden="true">2.5.</strong> Lexing and Parsing</a></li><li class=""><a href="../test-implementation.html"><strong aria-hidden="true">2.6.</strong> #[test] Implementation</a></li><li class=""><a href="../panic-implementation.html"><strong aria-hidden="true">2.7.</strong> Panic Implementation</a></li><li class=""><a href="../macro-expansion.html"><strong aria-hidden="true">2.8.</strong> Macro expansion</a></li><li class=""><a href="../name-resolution.html"><strong aria-hidden="true">2.9.</strong> Name resolution</a></li><li class=""><a href="../hir.html"><strong aria-hidden="true">2.10.</strong> The HIR (High-level IR)</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../lowering.html"><strong aria-hidden="true">2.10.1.</strong> Lowering AST to HIR</a></li><li class=""><a href="../hir-debugging.html"><strong aria-hidden="true">2.10.2.</strong> Debugging</a></li></ol></li><li class=""><a href="../closure.html"><strong aria-hidden="true">2.11.</strong> Closure expansion</a></li><li class=""><a href="../ty.html"><strong aria-hidden="true">2.12.</strong> The ty module: representing types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../generics.html"><strong aria-hidden="true">2.12.1.</strong> Generics and substitutions</a></li><li class=""><a href="../ty-fold.html"><strong aria-hidden="true">2.12.2.</strong> TypeFolder and TypeFoldable</a></li><li class=""><a href="../generic_arguments.html"><strong aria-hidden="true">2.12.3.</strong> Generic arguments</a></li></ol></li><li class=""><a href="../type-inference.html"><strong aria-hidden="true">2.13.</strong> Type inference</a></li><li class=""><a href="../traits/resolution.html"><strong aria-hidden="true">2.14.</strong> Trait solving (old-style)</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../traits/hrtb.html"><strong aria-hidden="true">2.14.1.</strong> Higher-ranked trait bounds</a></li><li class=""><a href="../traits/caching.html"><strong aria-hidden="true">2.14.2.</strong> Caching subtleties</a></li><li class=""><a href="../traits/specialization.html"><strong aria-hidden="true">2.14.3.</strong> Specialization</a></li></ol></li><li class="expanded "><a href="../traits/index.html"><strong aria-hidden="true">2.15.</strong> Trait solving (new-style)</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="expanded "><a href="../traits/lowering-to-logic.html" class="active"><strong aria-hidden="true">2.15.1.</strong> Lowering to logic</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../traits/goals-and-clauses.html"><strong aria-hidden="true">2.15.1.1.</strong> Goals and clauses</a></li><li class=""><a href="../traits/associated-types.html"><strong aria-hidden="true">2.15.1.2.</strong> Equality and associated types</a></li><li class=""><a href="../traits/implied-bounds.html"><strong aria-hidden="true">2.15.1.3.</strong> Implied bounds</a></li><li class=""><a href="../traits/regions.html"><strong aria-hidden="true">2.15.1.4.</strong> Region constraints</a></li><li class=""><a href="../traits/lowering-module.html"><strong aria-hidden="true">2.15.1.5.</strong> The lowering module in rustc</a></li><li class=""><a href="../traits/lowering-rules.html"><strong aria-hidden="true">2.15.1.6.</strong> Lowering rules</a></li><li class=""><a href="../traits/wf.html"><strong aria-hidden="true">2.15.1.7.</strong> Well-formedness checking</a></li></ol></li><li class=""><a href="../traits/canonical-queries.html"><strong aria-hidden="true">2.15.2.</strong> Canonical queries</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../traits/canonicalization.html"><strong aria-hidden="true">2.15.2.1.</strong> Canonicalization</a></li></ol></li><li class=""><a href="../traits/slg.html"><strong aria-hidden="true">2.15.3.</strong> The SLG solver</a></li><li class=""><a href="../traits/chalk-overview.html"><strong aria-hidden="true">2.15.4.</strong> An Overview of Chalk</a></li><li class=""><a href="../traits/bibliography.html"><strong aria-hidden="true">2.15.5.</strong> Bibliography</a></li></ol></li><li class=""><a href="../type-checking.html"><strong aria-hidden="true">2.16.</strong> Type checking</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../method-lookup.html"><strong aria-hidden="true">2.16.1.</strong> Method Lookup</a></li><li class=""><a href="../variance.html"><strong aria-hidden="true">2.16.2.</strong> Variance</a></li><li class=""><a href="../opaque-types-type-alias-impl-trait.html"><strong aria-hidden="true">2.16.3.</strong> Opaque Types</a></li></ol></li><li class=""><a href="../mir/index.html"><strong aria-hidden="true">2.17.</strong> The MIR (Mid-level IR)</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../mir/construction.html"><strong aria-hidden="true">2.17.1.</strong> MIR construction</a></li><li class=""><a href="../mir/visitor.html"><strong aria-hidden="true">2.17.2.</strong> MIR visitor and traversal</a></li><li class=""><a href="../mir/passes.html"><strong aria-hidden="true">2.17.3.</strong> MIR passes: getting the MIR for a function</a></li><li class=""><a href="../mir/optimizations.html"><strong aria-hidden="true">2.17.4.</strong> MIR optimizations</a></li><li class=""><a href="../mir/debugging.html"><strong aria-hidden="true">2.17.5.</strong> Debugging</a></li></ol></li><li class=""><a href="../borrow_check.html"><strong aria-hidden="true">2.18.</strong> The borrow checker</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../borrow_check/moves_and_initialization.html"><strong aria-hidden="true">2.18.1.</strong> Tracking moves and initialization</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../borrow_check/moves_and_initialization/move_paths.html"><strong aria-hidden="true">2.18.1.1.</strong> Move paths</a></li></ol></li><li class=""><a href="../borrow_check/type_check.html"><strong aria-hidden="true">2.18.2.</strong> MIR type checker</a></li><li class=""><a href="../borrow_check/region_inference.html"><strong aria-hidden="true">2.18.3.</strong> Region inference</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../borrow_check/region_inference/constraint_propagation.html"><strong aria-hidden="true">2.18.3.1.</strong> Constraint propagation</a></li><li class=""><a href="../borrow_check/region_inference/lifetime_parameters.html"><strong aria-hidden="true">2.18.3.2.</strong> Lifetime parameters</a></li><li class=""><a href="../borrow_check/region_inference/member_constraints.html"><strong aria-hidden="true">2.18.3.3.</strong> Member constraints</a></li><li class=""><a href="../borrow_check/region_inference/placeholders_and_universes.html"><strong aria-hidden="true">2.18.3.4.</strong> Placeholders and universes</a></li><li class=""><a href="../borrow_check/region_inference/closure_constraints.html"><strong aria-hidden="true">2.18.3.5.</strong> Closure constraints</a></li><li class=""><a href="../borrow_check/region_inference/error_reporting.html"><strong aria-hidden="true">2.18.3.6.</strong> Error reporting</a></li></ol></li><li class=""><a href="../borrow_check/two_phase_borrows.html"><strong aria-hidden="true">2.18.4.</strong> Two-phase-borrows</a></li></ol></li><li class=""><a href="../const-eval.html"><strong aria-hidden="true">2.19.</strong> Constant evaluation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../miri.html"><strong aria-hidden="true">2.19.1.</strong> miri const evaluator</a></li></ol></li><li class=""><a href="../param_env.html"><strong aria-hidden="true">2.20.</strong> Parameter Environments</a></li><li class=""><a href="../backend/backend.html"><strong aria-hidden="true">2.21.</strong> Compiler Backend</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../backend/monomorph.html"><strong aria-hidden="true">2.21.1.</strong> Monomorphization</a></li><li class=""><a href="../backend/lowering-mir.html"><strong aria-hidden="true">2.21.2.</strong> Lowering MIR</a></li><li class=""><a href="../backend/codegen.html"><strong aria-hidden="true">2.21.3.</strong> Code Generation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class=""><a href="../backend/updating-llvm.html"><strong aria-hidden="true">2.21.3.1.</strong> Updating LLVM</a></li><li class=""><a href="../backend/debugging.html"><strong aria-hidden="true">2.21.3.2.</strong> Debugging LLVM</a></li><li class=""><a href="../backend/backend-agnostic.html"><strong aria-hidden="true">2.21.3.3.</strong> Backend Agnostic Codegen</a></li></ol></li><li class=""><a href="../profile-guided-optimization.html"><strong aria-hidden="true">2.21.4.</strong> Profile-guided Optimization</a></li><li class=""><a href="../sanitizers.html"><strong aria-hidden="true">2.21.5.</strong> Sanitizers Support</a></li><li class=""><a href="../debugging-support-in-rustc.html"><strong aria-hidden="true">2.21.6.</strong> Debugging Support in Rust Compiler</a></li><li class="spacer"></li></ol></li></ol></li><li class="expanded "><a href="../appendix/stupid-stats.html">Appendix A: Stupid Stats</a></li><li class="expanded affix "><a href="../appendix/background.html">Appendix B: Background material</a></li><li class="expanded affix "><a href="../appendix/glossary.html">Appendix C: Glossary</a></li><li class="expanded affix "><a href="../appendix/code-index.html">Appendix D: Code Index</a></li><li class="expanded affix "><a href="../appendix/compiler-lecture.html">Appendix E: Compiler Lecture Series</a></li><li class="expanded affix "><a href="../appendix/bibliography.html">Appendix F: Bibliography</a></li><li class="expanded affix "><a href="../appendix/humorust.html">Appendix Z: HumorRust</a></li><li class="spacer"></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Guide to Rustc Development</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/rust-lang/rustc-dev-guide" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-github"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#lowering-to-logic" id="lowering-to-logic">Lowering to logic</a></h1>
<p>The key observation here is that the Rust trait system is basically a
kind of logic, and it can be mapped onto standard logical inference
rules. We can then look for solutions to those inference rules in a
very similar fashion to how e.g. a <a href="https://en.wikipedia.org/wiki/Prolog">Prolog</a> solver works. It turns out
that we can't <em>quite</em> use Prolog rules (also called Horn clauses) but
rather need a somewhat more expressive variant.</p>
<h2><a class="header" href="#rust-traits-and-logic" id="rust-traits-and-logic">Rust traits and logic</a></h2>
<p>One of the first observations is that the Rust trait system is
basically a kind of logic. As such, we can map our struct, trait, and
impl declarations into logical inference rules. For the most part,
these are basically Horn clauses, though we'll see that to capture the
full richness of Rust – and in particular to support generic
programming – we have to go a bit further than standard Horn clauses.</p>
<p>To see how this mapping works, let's start with an example. Imagine
we declare a trait and a few impls, like so:</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
fn main() {
</span>trait Clone { }
impl Clone for usize { }
impl&lt;T&gt; Clone for Vec&lt;T&gt; where T: Clone { }
<span class="boring">}
</code></pre></pre>
<p>We could map these declarations to some Horn clauses, written in a
Prolog-like notation, as follows:</p>
<pre><code class="language-text">Clone(usize).
Clone(Vec&lt;?T&gt;) :- Clone(?T).

// The notation `A :- B` means &quot;A is true if B is true&quot;.
// Or, put another way, B implies A.
</code></pre>
<p>In Prolog terms, we might say that <code>Clone(Foo)</code> – where <code>Foo</code> is some
Rust type – is a <em>predicate</em> that represents the idea that the type
<code>Foo</code> implements <code>Clone</code>. These rules are <strong>program clauses</strong>; they
state the conditions under which that predicate can be proven (i.e.,
considered true). So the first rule just says &quot;Clone is implemented
for <code>usize</code>&quot;. The next rule says &quot;for any type <code>?T</code>, Clone is
implemented for <code>Vec&lt;?T&gt;</code> if clone is implemented for <code>?T</code>&quot;. So
e.g. if we wanted to prove that <code>Clone(Vec&lt;Vec&lt;usize&gt;&gt;)</code>, we would do
so by applying the rules recursively:</p>
<ul>
<li><code>Clone(Vec&lt;Vec&lt;usize&gt;&gt;)</code> is provable if:
<ul>
<li><code>Clone(Vec&lt;usize&gt;)</code> is provable if:
<ul>
<li><code>Clone(usize)</code> is provable. (Which it is, so we're all good.)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>But now suppose we tried to prove that <code>Clone(Vec&lt;Bar&gt;)</code>. This would
fail (after all, I didn't give an impl of <code>Clone</code> for <code>Bar</code>):</p>
<ul>
<li><code>Clone(Vec&lt;Bar&gt;)</code> is provable if:
<ul>
<li><code>Clone(Bar)</code> is provable. (But it is not, as there are no applicable rules.)</li>
</ul>
</li>
</ul>
<p>We can easily extend the example above to cover generic traits with
more than one input type. So imagine the <code>Eq&lt;T&gt;</code> trait, which declares
that <code>Self</code> is equatable with a value of type <code>T</code>:</p>
<pre><code class="language-rust ignore">trait Eq&lt;T&gt; { ... }
impl Eq&lt;usize&gt; for usize { }
impl&lt;T: Eq&lt;U&gt;&gt; Eq&lt;Vec&lt;U&gt;&gt; for Vec&lt;T&gt; { }
</code></pre>
<p>That could be mapped as follows:</p>
<pre><code class="language-text">Eq(usize, usize).
Eq(Vec&lt;?T&gt;, Vec&lt;?U&gt;) :- Eq(?T, ?U).
</code></pre>
<p>So far so good.</p>
<h2><a class="header" href="#type-checking-normal-functions" id="type-checking-normal-functions">Type-checking normal functions</a></h2>
<p>OK, now that we have defined some logical rules that are able to
express when traits are implemented and to handle associated types,
let's turn our focus a bit towards <strong>type-checking</strong>. Type-checking is
interesting because it is what gives us the goals that we need to
prove. That is, everything we've seen so far has been about how we
derive the rules by which we can prove goals from the traits and impls
in the program; but we are also interested in how to derive the goals
that we need to prove, and those come from type-checking.</p>
<p>Consider type-checking the function <code>foo()</code> here:</p>
<pre><code class="language-rust ignore">fn foo() { bar::&lt;usize&gt;() }
fn bar&lt;U: Eq&lt;U&gt;&gt;() { }
</code></pre>
<p>This function is very simple, of course: all it does is to call
<code>bar::&lt;usize&gt;()</code>. Now, looking at the definition of <code>bar()</code>, we can see
that it has one where-clause <code>U: Eq&lt;U&gt;</code>. So, that means that <code>foo()</code> will
have to prove that <code>usize: Eq&lt;usize&gt;</code> in order to show that it can call <code>bar()</code>
with <code>usize</code> as the type argument.</p>
<p>If we wanted, we could write a Prolog predicate that defines the
conditions under which <code>bar()</code> can be called. We'll say that those
conditions are called being &quot;well-formed&quot;:</p>
<pre><code class="language-text">barWellFormed(?U) :- Eq(?U, ?U).
</code></pre>
<p>Then we can say that <code>foo()</code> type-checks if the reference to
<code>bar::&lt;usize&gt;</code> (that is, <code>bar()</code> applied to the type <code>usize</code>) is
well-formed:</p>
<pre><code class="language-text">fooTypeChecks :- barWellFormed(usize).
</code></pre>
<p>If we try to prove the goal <code>fooTypeChecks</code>, it will succeed:</p>
<ul>
<li><code>fooTypeChecks</code> is provable if:
<ul>
<li><code>barWellFormed(usize)</code>, which is provable if:
<ul>
<li><code>Eq(usize, usize)</code>, which is provable because of an impl.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Ok, so far so good. Let's move on to type-checking a more complex function.</p>
<h2><a class="header" href="#type-checking-generic-functions-beyond-horn-clauses" id="type-checking-generic-functions-beyond-horn-clauses">Type-checking generic functions: beyond Horn clauses</a></h2>
<p>In the last section, we used standard Prolog horn-clauses (augmented with Rust's
notion of type equality) to type-check some simple Rust functions. But that only
works when we are type-checking non-generic functions. If we want to type-check
a generic function, it turns out we need a stronger notion of goal than what Prolog
can provide. To see what I'm talking about, let's revamp our previous
example to make <code>foo</code> generic:</p>
<pre><code class="language-rust ignore">fn foo&lt;T: Eq&lt;T&gt;&gt;() { bar::&lt;T&gt;() }
fn bar&lt;U: Eq&lt;U&gt;&gt;() { }
</code></pre>
<p>To type-check the body of <code>foo</code>, we need to be able to hold the type
<code>T</code> &quot;abstract&quot;.  That is, we need to check that the body of <code>foo</code> is
type-safe <em>for all types <code>T</code></em>, not just for some specific type. We might express
this like so:</p>
<pre><code class="language-text">fooTypeChecks :-
  // for all types T...
  forall&lt;T&gt; {
    // ...if we assume that Eq(T, T) is provable...
    if (Eq(T, T)) {
      // ...then we can prove that `barWellFormed(T)` holds.
      barWellFormed(T)
    }
  }.
</code></pre>
<p>This notation I'm using here is the notation I've been using in my
prototype implementation; it's similar to standard mathematical
notation but a bit Rustified. Anyway, the problem is that standard
Horn clauses don't allow universal quantification (<code>forall</code>) or
implication (<code>if</code>) in goals (though many Prolog engines do support
them, as an extension). For this reason, we need to accept something
called &quot;first-order hereditary harrop&quot; (FOHH) clauses – this long
name basically means &quot;standard Horn clauses with <code>forall</code> and <code>if</code> in
the body&quot;. But it's nice to know the proper name, because there is a
lot of work describing how to efficiently handle FOHH clauses; see for
example Gopalan Nadathur's excellent
<a href="./bibliography.html#pphhf">&quot;A Proof Procedure for the Logic of Hereditary Harrop Formulas&quot;</a>
in <a href="./bibliography.html">the bibliography</a>.</p>
<p>It turns out that supporting FOHH is not really all that hard. And
once we are able to do that, we can easily describe the type-checking
rule for generic functions like <code>foo</code> in our logic.</p>
<h2><a class="header" href="#source" id="source">Source</a></h2>
<p>This page is a lightly adapted version of a
<a href="http://smallcultfollowing.com/babysteps/blog/2017/01/26/lowering-rust-traits-to-logic/">blog post by Nicholas Matsakis</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../traits/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../traits/goals-and-clauses.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../traits/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../traits/goals-and-clauses.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
